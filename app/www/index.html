<html>

<head>
    <title>Media Center</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            background-color: #181818;
            color: white;
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", "Noto Sans", "Liberation Sans", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            overflow-x: hidden;
            scrollbar-width: thin;
            scrollbar-color: gray transparent;
            margin: 0;
        }

        #title {
            margin: 5px;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
            width: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background-color: gray;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: lightgray;
            border-radius: 5px;
        }

        .collection {
            border-radius: 5px;
            margin-right: 5px;
            margin-left: 5px;
            display: flex;
            flex-direction: row;
            align-items: center;
            margin-bottom: 25px;
            height: 275px;
            overflow-x: scroll;
            overflow-y: hidden;
        }

        .collection img {
            max-width: 250px;
            max-height: 250px;
            border-radius: 5px;
            margin-right: 10px;
        }

        .collection a {
            text-decoration: none;
            cursor: pointer;
        }

        .collection-title {
            margin: 5px;
            text-transform: capitalize;
        }

        #media-info {
            border-radius: 5px;
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 85%;
            height: 85%;
            background-color: #202020;
            padding: 0px;
            margin: 0px;
        }

        #media-info-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            -webkit-backdrop-filter: blur(3px);
            backdrop-filter: blur(3px);
        }

        #media-info-inner {
            padding: 10px;
            position: relative;
        }

        #media-info-close {
            position: absolute;
            top: 0;
            right: 8px;
            font-size: x-large;
            cursor: pointer;
            font-weight: 500;
            margin: 0;
            padding: 0;
        }

        @keyframes media-info-open {
            0% {
                display: none;
                opacity: 0;
                transform: translateX(-50%) scale(0);
            }

            100% {
                display: block;
                opacity: 1;
                transform: translateX(-50%) scale(1);
            }
        }

        @keyframes media-info-close {
            0% {
                display: block;
                opacity: 1;
                transform: translateX(-50%) scale(1);
            }

            100% {
                display: none;
                opacity: 0;
                transform: translateX(-50%) scale(0);
            }
        }
    </style>
</head>

<body>
    <h1 id="title">Media Center</h1>
    <div id="media-info-background" style="display: none;"></div>
    <div id="media-info" style="animation: media-info-close 0s forwards;">
        <div id="media-info-inner">
            <a id="media-info-close">X</a>
        </div>
    </div>
    <script>
        document.getElementById('media-info-close').onclick = () => {
            document.getElementById('media-info').style.animation = 'media-info-close 0.5s forwards';
            document.getElementById('media-info-background').style.display = 'none';
        }
        document.getElementById('media-info-background').onclick = () => {
            document.getElementById('media-info').style.animation = 'media-info-close 0.5s forwards';
            document.getElementById('media-info-background').style.display = 'none';
        };

        function openMedaInfo(collection_id, imdb_id) {
            document.getElementById('media-info').style.animation = 'media-info-open 0.5s forwards';
            document.getElementById('media-info-background').style.display = 'block';
            console.log(collection_id, imdb_id);
        }

        var done = {};
        var offsets = {};
        async function fetchCollectionMedia(collection_id, limit = 0, offset = 0) {
            const res = await fetch('/api/collection-media?limit=' + limit + '&offset=' + offset + '&collection=' + collection_id);
            const data = await res.json();
            if (data.media.length < limit) { // this is the last page
                offsets[collection_id] = -1;
            }
            for (const media of data.media) {
                if (!done[collection_id]) {
                    done[collection_id] = {};
                }
                if (done[collection_id][media.imdb_id]) {
                    continue;
                }
                const imdb = JSON.parse((await (await fetch('/api/imdb?id=' + media.imdb_id)).json()).json);
                const a = document.createElement('a');
                a.onclick = () => {
                    openMedaInfo(collection_id, media.imdb_id);
                    //window.location = '/stream/' + media.id;
                }
                const img = document.createElement('img');
                img.src = imdb.meta.image ? imdb.meta.image.url : '';
                a.appendChild(img);
                document.getElementById(`collection-${collection_id}`).appendChild(a);
                done[collection_id][media.imdb_id] = true;
            }
        }

        (async () => {
            const res = await fetch('/api/collections');
            const data = await res.json();
            for (const collection of data) {
                const title = document.createElement('h3');
                title.className = 'collection-title';
                title.innerText = collection.name;
                document.body.appendChild(title);
                const div = document.createElement('div');
                div.className = 'collection';
                div.id = `collection-${collection.id}`;
                offsets[collection.id] = 0;
                var lastScroll = Date.now()
                div.onscroll = () => {
                    if (div.scrollWidth - div.clientWidth - div.scrollLeft < (div.clientWidth * 0.25)) {
                        if (offsets[collection.id] != -1 && Date.now() - lastScroll > 250) { // 0.25s delay
                            lastScroll = Date.now();
                            offsets[collection.id] += 15;
                            fetchCollectionMedia(collection.id, 15, offsets[collection.id]);
                        }
                    }
                }
                document.body.appendChild(div);
                await fetchCollectionMedia(collection.id, 15, 0);
            }
        })();
    </script>
</body>

</html>